<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Figma MCP Plugin</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                margin: 0;
                padding: 8px;
                background: #ffffff;
                font-size: 13px;
                line-height: 1.5;
                color: #1d1d1d;
                width: 320px;
                height: 100vh;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
                color: #6b7280;
                margin: 0 0 8px 0;
                text-align: center;
            }

            .status {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 8px;
                margin-bottom: 4px;
            }

            .status-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #ef4444;
                margin-left: 4px;
            }

            .status-dot.connected {
                background: #10b981;
            }

            .status-text {
                color: #374151;
                font-weight: 500;
            }

            .disconnect-btn {
                width: 100%;
                padding: 8px;
                border: none;
                border-radius: 6px;
                background: #6b7280;
                color: white;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
            }

            .disconnect-btn:hover {
                background: #4b5563;
            }

            .connect-btn {
                background: #3b82f6;
            }

            .connect-btn:hover {
                background: #2563eb;
            }

            .log {
                background: #1f2937;
                color: #f9fafb;
                padding: 8px;
                border-radius: 6px;
                font-family: "SF Mono", Monaco, monospace;
                font-size: 11px;
                line-height: 1.5;
                flex: 1;
                min-height: 0;
                overflow-y: auto;
            }

            .log-entry {
                margin-bottom: 4px;
            }

            .log-entry.error {
                color: #fca5a5;
            }

            .log-entry.success {
                color: #86efac;
            }

            .log-entry.info {
                color: #93c5fd;
            }
        </style>
    </head>
    <body>
        <div class="title">MCP WebSocket Client v{{VERSION}}</div>

        <div class="log" id="logContainer">
            <div class="log-entry info">🚀 Plugin UI loaded</div>
        </div>

        <div class="status">
            <div class="status-dot" id="connectionIndicator"></div>
            <div class="status-text" id="connectionStatus">
                Connecting to localhost:8765...
            </div>
        </div>

        <button class="disconnect-btn" id="connectionToggle">Connect</button>

        <script>
            let ws = null;
            let isConnected = false;
            let connectionAttempts = 0;
            let maxReconnectAttempts = 10;
            let reconnectTimer = null;

            const connectionIndicator = document.getElementById(
                "connectionIndicator",
            );
            const connectionStatus =
                document.getElementById("connectionStatus");
            const connectionToggle =
                document.getElementById("connectionToggle");
            const logContainer = document.getElementById("logContainer");

            function log(message, type = "info") {
                const entry = document.createElement("div");
                entry.className = `log-entry ${type}`;
                entry.textContent = message;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
                console.log(message);
            }

            function updateConnectionStatus(
                connected,
                message,
                isConnecting = false,
            ) {
                isConnected = connected;
                connectionIndicator.className = `status-dot ${connected ? "connected" : ""}`;
                connectionStatus.textContent = message;

                if (isConnecting) {
                    connectionToggle.textContent = "Connecting...";
                    connectionToggle.disabled = true;
                    connectionToggle.className = "disconnect-btn";
                } else if (connected) {
                    connectionToggle.textContent = "Disconnect";
                    connectionToggle.disabled = false;
                    connectionToggle.className = "disconnect-btn";
                } else {
                    connectionToggle.textContent = "Connect";
                    connectionToggle.disabled = false;
                    connectionToggle.className = "disconnect-btn connect-btn";
                }
            }

            function connect() {
                if (isConnected || connectionAttempts >= maxReconnectAttempts) {
                    return;
                }

                connectionAttempts++;
                log(
                    `Connecting to MCP server (attempt ${connectionAttempts})...`,
                    "info",
                );
                updateConnectionStatus(false, "Connecting...", true);

                try {
                    ws = new WebSocket("ws://localhost:8765");

                    ws.onopen = () => {
                        log("✅ Connected to MCP server", "success");
                        updateConnectionStatus(
                            true,
                            "Connected to localhost:8765",
                        );
                        connectionAttempts = 0;
                        clearReconnectTimer();
                        ws.send(JSON.stringify({ type: "PLUGIN_HELLO" }));
                    };

                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            handleMessage(message);
                        } catch (error) {
                            log(
                                `❌ Failed to parse message: ${error.message}`,
                                "error",
                            );
                        }
                    };

                    ws.onclose = () => {
                        log("❌ Connection closed", "error");
                        updateConnectionStatus(false, "Disconnected");
                        scheduleReconnect();
                    };

                    ws.onerror = (error) => {
                        log(`💥 WebSocket error: ${error}`, "error");
                        updateConnectionStatus(false, "Connection error");
                    };
                } catch (error) {
                    log(`❌ Failed to connect: ${error.message}`, "error");
                    updateConnectionStatus(false, "Connection failed");
                    scheduleReconnect();
                }
            }

            function disconnect() {
                clearReconnectTimer();
                if (ws) {
                    ws.close();
                    ws = null;
                }
                updateConnectionStatus(false, "Disconnected");
                log("🛑 Disconnected from MCP server", "info");
            }

            function scheduleReconnect() {
                if (
                    reconnectTimer ||
                    connectionAttempts >= maxReconnectAttempts
                ) {
                    return;
                }

                const delay = Math.min(
                    1000 * Math.pow(2, connectionAttempts - 1),
                    30000,
                );

                reconnectTimer = setTimeout(() => {
                    log(`🔄 Reconnecting in ${delay}ms...`, "info");
                    reconnectTimer = null;
                    connect();
                }, delay);
            }

            function clearReconnectTimer() {
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            }

            function handleMessage(message) {
                log(`📨 Received: ${message.type}`, "info");

                if (message.type && message.id) {
                    log(`🔄 Forwarding ${message.type} to main thread`, "info");
                    parent.postMessage(
                        {
                            pluginMessage: {
                                type: "PLUGIN_OPERATION",
                                operation: message.type,
                                payload: message.payload,
                                id: message.id,
                            },
                        },
                        "*",
                    );
                } else if (message.type === "CONNECTED") {
                    log(`✅ Server acknowledged connection`, "success");
                } else if (message.type === "HEARTBEAT") {
                    // Handle heartbeat messages - no id required
                    log(`💓 Heartbeat received`, "info");
                    // Send heartbeat acknowledgment back to server
                    if (ws && isConnected) {
                        ws.send(JSON.stringify({ type: 'HEARTBEAT_ACK', timestamp: Date.now() }));
                    }
                } else if (message.type === "HEARTBEAT_ACK") {
                    // Handle heartbeat acknowledgment - no id required
                    log(`💓 Heartbeat ACK received`, "info");
                } else {
                    log(
                        `⚠️ Message missing required fields (type/id): ${JSON.stringify(message)}`,
                        "error",
                    );
                }
            }

            function sendResponse(id, success, data = null, error = null) {
                if (ws && isConnected) {
                    const response = { id, success, data, error };
                    ws.send(JSON.stringify(response));
                    log(
                        `📤 Sent response for ${id}`,
                        success ? "success" : "error",
                    );
                }
            }

            window.addEventListener("message", (event) => {
                const msg = event.data.pluginMessage;
                if (!msg) return;

                switch (msg.type) {
                    case "OPERATION_RESPONSE":
                        sendResponse(msg.id, msg.success, msg.data, msg.error);
                        break;
                }
            });

            connectionToggle.addEventListener("click", () => {
                if (isConnected) {
                    disconnect();
                } else {
                    connect();
                }
            });

            log("🚀 Auto-connecting to MCP server...", "info");
            setTimeout(connect, 1000);
        </script>
    </body>
</html>
